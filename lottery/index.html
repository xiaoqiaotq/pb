<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 ç››ä¸–å¹´ä¼š - å¹¸è¿æŠ½å¥–ç³»ç»Ÿ (é©¬å¹´ç‰¹åˆ«ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    
    <style>
        :root { --gold: #ffd700; --crimson: #c41e3a; --dark-red: #4a0000; }
        body { background: radial-gradient(circle at center, #800000 0%, #200000 100%); color: white; font-family: 'PingFang SC', sans-serif; overflow: hidden; height: 100vh; }
        body::before { content: ""; position: fixed; inset: 0; background-image: url('https://www.transparenttextures.com/patterns/oriental-tiles.png'); opacity: 0.1; pointer-events: none; z-index: 0; }
        
        .title-font { font-family: 'ZCOOL KuaiLe', cursive; background: linear-gradient(to bottom, #fff7ad 0%, #ffa500 50%, #b8860b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5)); }
        
        #lotteryStage { position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        .name-stream { position: absolute; font-size: 2rem; font-weight: bold; color: rgba(255, 215, 0, 0.3); white-space: nowrap; pointer-events: none; user-select: none; }
        
        .winner-card { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; transform: scale(0); }
        @keyframes popIn { to { opacity: 1; transform: scale(1); } }
        
        /* å°Šäº«ç‰ˆå®šæ ¼æŒ‰é’® */
        .btn-stop {
            width: 240px;
            height: 240px;
            background: radial-gradient(circle, #ff0000 0%, #660000 100%);
            border: 6px solid var(--gold);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.6), inset 0 0 30px rgba(0,0,0,0.5);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            animation: pulse-button 1.5s infinite;
        }

        .btn-stop::before {
            content: '';
            position: absolute;
            inset: -15px;
            border: 3px dashed var(--gold);
            border-radius: 50%;
            animation: rotate-ring 8s linear infinite;
            opacity: 0.6;
        }

        .btn-stop::after {
            content: '';
            position: absolute;
            inset: -25px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            animation: pulse-ring 1.5s infinite;
        }

        @keyframes rotate-ring {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.8; }
            100% { transform: scale(1.4); opacity: 0; }
        }

        @keyframes pulse-button {
            0%, 100% { transform: scale(1); box-shadow: 0 0 50px rgba(255, 0, 0, 0.6); }
            50% { transform: scale(1.05); box-shadow: 0 0 80px rgba(255, 0, 0, 0.8); }
        }

        .btn-stop:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }

        .btn-stop:active {
            transform: scale(0.9);
        }

        .btn-stop span:first-child {
            font-size: 3rem;
            font-weight: 900;
            color: var(--gold);
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            letter-spacing: 4px;
        }

        .btn-stop span:last-child {
            font-size: 1rem;
            color: rgba(255, 215, 0, 0.8);
            margin-top: 5px;
            font-weight: bold;
        }

        .glass-panel { background: rgba(139, 0, 0, 0.2); backdrop-filter: blur(15px); border: 2px solid rgba(255, 215, 0, 0.3); border-radius: 1.5rem; }

        .horse-icon { font-size: 3rem; position: fixed; bottom: 20px; right: 20px; opacity: 0.3; animation: gallop 2s infinite linear; }
        @keyframes gallop { 0%, 100% { transform: translate(0,0); } 50% { transform: translate(-10px,-10px); } }

        /* å½»åº•å¼ºåˆ¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
        #winnersList {
            overflow-y: scroll !important; /* å¼ºåˆ¶æ˜¾ç¤ºæ»šåŠ¨æ§½ï¼Œæ— è®ºæ˜¯å¦éœ€è¦ */
            scrollbar-width: thin !important;
            scrollbar-color: #ffd700 #200000 !important;
        }

        #winnersList::-webkit-scrollbar {
            width: 10px !important;
            display: block !important;
        }
        
        #winnersList::-webkit-scrollbar-track {
            background: #200000 !important;
            border-radius: 10px !important;
        }
        
        #winnersList::-webkit-scrollbar-thumb {
            background-color: #ffd700 !important;
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent) !important;
            background-size: 20px 20px !important;
            border-radius: 10px !important;
            border: 1px solid #000 !important;
        }

        #winnersList::-webkit-scrollbar-thumb:hover {
            background-color: #ffffff !important;
        }

        #resultBox { z-index: 200; position: relative; }
    </style>
</head>
<body class="p-4 md:p-8">
    <audio id="bgMusic" loop><source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg"></audio>
    <audio id="scrollSound"><source src="https://assets.mixkit.co/active_storage/sfx/2004/2004-preview.mp3" type="audio/mpeg"></audio>
    <audio id="winSound"><source src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" type="audio/mpeg"></audio>

    <div class="max-w-7xl mx-auto h-full flex flex-col relative z-10">
        <header class="text-center mb-6 relative pt-2">
            <div class="flex items-center justify-center space-x-4">
                <span class="text-4xl">ğŸ</span>
                <h1 class="text-6xl md:text-7xl title-font">2026 å¥”è…¾é©¬å¹´</h1>
                <span class="text-4xl">ğŸ</span>
            </div>
            <div class="absolute right-0 top-2 space-x-2">
                <button onclick="toggleMusic()" id="musicBtn" class="p-2 glass-panel hover:bg-white/10 text-xs">ğŸ”‡ éŸ³ä¹å…³é—­</button>
                <button onclick="toggleConfig()" class="p-2 glass-panel hover:bg-white/10 text-xs">âš™ï¸ é…ç½®</button>
            </div>
        </header>

        <main class="flex-1 grid grid-cols-1 lg:grid-cols-10 gap-6 overflow-hidden pb-4">
            <!-- å·¦ä¾§ï¼šä¸­å¥–æ¦œ -->
            <div class="glass-panel p-6 flex flex-col h-full lg:col-span-3 min-h-0 overflow-hidden">
                <h2 class="text-xl text-yellow-500 mb-4 font-bold border-b border-yellow-500/20 pb-2 italic flex-shrink-0">WINNERS è£è€€æ¦œå•</h2>
                <div id="winnersList" class="flex-1 overflow-y-auto scroll-smooth pr-2 min-h-0"></div>
                <button onclick="exportToExcel()" class="mt-4 w-full py-2 rounded-xl bg-green-800/80 text-white font-bold text-xs flex-shrink-0">ğŸ“Š å¯¼å‡ºç»“æœ</button>
            </div>

            <!-- å³ä¾§ï¼šæ ¸å¿ƒåŒº -->
            <div class="lg:col-span-7 flex flex-col space-y-4">
                <div class="glass-panel p-4 flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <select id="prizeSelect" class="bg-black/40 text-yellow-500 font-bold p-2 rounded border border-yellow-500/30 outline-none" onchange="updatePrizeId(this.value)">
                            <option value="">-- é€‰æ‹©å¥–é¡¹ --</option>
                        </select>
                        <div class="text-sm">
                            <span class="opacity-60">åé¢:</span> <span id="prizeQuota" class="text-yellow-500 font-bold mr-4">0</span>
                            <span class="opacity-60">å·²æŠ½:</span> <span id="prizeDrawn" class="text-green-400 font-bold">0</span>
                        </div>
                    </div>
                    <div class="flex bg-black/40 p-1 rounded-lg border border-white/10">
                        <button id="mode1" onclick="setMode(1)" class="px-4 py-1 rounded-md text-xs transition bg-yellow-600">å•æŠ½</button>
                        <button id="mode5" onclick="setMode(5)" class="px-4 py-1 rounded-md text-xs transition">äº”è¿æŠ½</button>
                    </div>
                </div>

                <div class="flex-1 glass-panel relative flex flex-col items-center justify-center overflow-hidden border-yellow-500/30">
                    <div class="text-center z-10">
                        <div class="text-7xl mb-4">ğŸ§§</div>
                        <h3 id="displayPrizeName" class="text-3xl text-yellow-200 font-bold tracking-widest">å‡†å¤‡å°±ç»ª</h3>
                        <p id="modeStatus" class="text-yellow-500/60 mt-2 text-xs uppercase tracking-widest">Single Draw Mode</p>
                    </div>
                    <button id="startBtn" onclick="handleDraw()" class="btn-gold px-20 py-6 rounded-2xl text-4xl shadow-2xl mt-8">ğŸ å¼€å¯å¥½è¿</button>
                </div>
            </div>
        </main>
    </div>

    <!-- æŠ½å¥–å¤§èˆå° -->
    <div id="lotteryStage">
        <div id="streamContainer" class="absolute inset-0"></div>
        
        <!-- æŠ½å¥–è¿‡ç¨‹ä¸­çš„åœæ­¢æŒ‰é’® -->
        <div id="drawingControls" class="z-[150] flex flex-col items-center">
            <div id="drawingPrizeName" class="text-yellow-200 text-3xl mb-16 tracking-[0.5rem] font-bold drop-shadow-lg">æ­£åœ¨æŠ½å–ï¼š...</div>
            
            <div id="stopBtn" onclick="stopDrawing()" class="btn-stop">
                <span>åœæ­¢</span>
                <span>LOCK LUCK</span>
            </div>
            
            <p class="mt-12 text-yellow-500/60 font-bold tracking-[0.3em] uppercase">æŒ‰ä¸‹æŒ‰é’® é”å®šå¥½è¿</p>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div id="resultBox" class="hidden z-[200] flex flex-col items-center max-w-5xl">
            <div class="text-yellow-200 text-2xl mb-6 tracking-[0.5rem] opacity-80" id="resPrizeLabel"></div>
            <div id="winnerContainer" class="flex flex-wrap justify-center gap-6 mb-12">
                <!-- åŠ¨æ€å±•ç¤º1ä¸ªæˆ–å¤šä¸ªä¸­å¥–è€… -->
            </div>
            <div class="flex space-x-6">
                <button onclick="closeResult()" class="px-12 py-4 bg-yellow-600 hover:bg-yellow-500 text-white text-xl font-bold rounded-full transition shadow-2xl">æ”¶ä¸‹å¥½è¿</button>
                <button id="continueBtn" onclick="closeResult(); handleDraw();" class="px-12 py-4 glass-panel text-yellow-500 text-xl font-bold rounded-full transition shadow-2xl">ç»§ç»­æŠ½å–</button>
            </div>
        </div>
    </div>

    <div class="horse-icon">ğŸ</div>

    <!-- ç®¡ç†åå°é®ç½©å±‚ -->
    <div id="configOverlay" onclick="toggleConfig()" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[250] hidden"></div>

    <!-- é…ç½®ç®¡ç† -->
    <div id="configDrawer" class="fixed inset-y-0 right-0 w-full md:w-[450px] bg-[#200] z-[300] transform translate-x-full transition-transform duration-300 shadow-2xl border-l border-yellow-500/30 flex flex-col text-sm">
        <div class="p-6 border-b border-yellow-500/20 flex justify-between items-center text-yellow-500 font-bold">
            <h3 class="text-xl">ç®¡ç†åå°</h3>
            <button onclick="toggleConfig()" class="text-2xl">&times;</button>
        </div>
        <div class="flex-1 overflow-y-auto p-6 space-y-8">
            <section>
                <div class="flex justify-between items-center mb-4">
                    <h4 class="border-l-4 border-yellow-500 pl-2">å‘˜å·¥åå• (<span id="empCount">0</span>)</h4>
                    <div class="flex gap-1">
                        <button onclick="document.getElementById('csvInput').click()" class="text-[10px] bg-blue-700 hover:bg-blue-600 px-2 py-1 rounded text-white font-bold">æ‰¹é‡å¯¼å…¥(CSV)</button>
                        <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="importCSV(this)">
                        <button onclick="generateTestData(100)" class="text-[10px] bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white">+100æµ‹è¯•</button>
                        <button onclick="clearEmployees()" class="text-[10px] bg-red-900 hover:bg-red-800 px-2 py-1 rounded text-white">æ¸…ç©º</button>
                    </div>
                </div>
                <!-- æ‰‹åŠ¨æ·»åŠ å‘˜å·¥è¡¨å• -->
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="newEmpName" placeholder="è¾“å…¥å§“å(å¦‚:å¼ ä¸‰)" class="flex-1 bg-black/40 border border-yellow-500/30 rounded px-3 py-2 text-white outline-none focus:border-yellow-500 transition">
                    <button onclick="addEmployee()" class="bg-yellow-600 hover:bg-yellow-500 px-4 py-2 rounded font-bold transition">æ·»åŠ </button>
                </div>
                <div id="empList" class="max-h-40 overflow-y-auto bg-black/20 p-2 rounded text-[10px] grid grid-cols-3 gap-1"></div>
            </section>

            <section>
                <div class="flex justify-between items-center mb-4">
                    <h4 class="border-l-4 border-yellow-500 pl-2">å¥–é¡¹è®¾ç½®</h4>
                    <button onclick="generateTestPrizes()" class="text-[10px] bg-gray-700 px-2 py-1 rounded text-white">æ¨¡æ‹Ÿå¥–å“</button>
                </div>
                <!-- æ‰‹åŠ¨æ·»åŠ å¥–é¡¹è¡¨å• -->
                <div class="grid grid-cols-1 gap-2 mb-4">
                    <div class="flex space-x-2">
                        <input type="text" id="newPrizeName" placeholder="å¥–é¡¹å(å¦‚:ä¸€ç­‰å¥–)" class="flex-1 bg-black/40 border border-yellow-500/30 rounded px-3 py-2 text-white outline-none">
                        <input type="number" id="newPrizeCount" placeholder="æ•°é‡" class="w-20 bg-black/40 border border-yellow-500/30 rounded px-2 py-2 text-white outline-none">
                    </div>
                    <button onclick="addPrize()" class="w-full bg-yellow-600 hover:bg-yellow-500 py-2 rounded font-bold transition">ç¡®è®¤æ·»åŠ å¥–é¡¹</button>
                </div>
                <div id="prizeListConfig" class="space-y-2"></div>
            </section>
            <section class="pt-4 border-t border-yellow-500/10 space-y-2">
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="exportConfig()" class="py-2 bg-blue-900/40 text-blue-300 rounded border border-blue-500/30 text-[10px] font-bold">ğŸ“¥ å¯¼å‡ºé…ç½®</button>
                    <button onclick="document.getElementById('configInput').click()" class="py-2 bg-green-900/40 text-green-300 rounded border border-green-500/30 text-[10px] font-bold">ğŸ“¤ å¯¼å…¥é…ç½®</button>
                    <input type="file" id="configInput" accept=".json" class="hidden" onchange="importConfig(this)">
                </div>
                <button onclick="resetSystem()" class="w-full py-2 bg-red-900/50 text-red-400 rounded text-[10px] font-bold">âš ï¸ é‡ç½®ç³»ç»Ÿ (æ¸…ç©ºæ‰€æœ‰)</button>
            </section>
        </div>
    </div>

    <script>
        let state = { 
            employees: [], 
            prizes: [], 
            currentPrizeId: null, 
            isDrawing: false, 
            musicPlaying: false, 
            drawMode: 1 
        };
        const STORAGE_KEY = 'ANNUAL_LOTTERY_2026_PRO';
        let streamInterval;

        window.onload = () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                // åªæ¢å¤æ ¸å¿ƒæ•°æ®ï¼ŒçŠ¶æ€å­—æ®µä¿æŒåˆå§‹å€¼
                state.employees = parsed.employees || [];
                state.prizes = parsed.prizes || [];
            }
            renderAll();
        };

                function save() { 

                    // ä»…ä¿å­˜åå•å’Œå¥–é¡¹ï¼ˆå«ä¸­å¥–è®°å½•ï¼‰

                    const dataToSave = {

                        employees: state.employees,

                        prizes: state.prizes

                    };

                    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave)); 

                }

        

                function toggleConfig() { 

                    const drawer = document.getElementById('configDrawer');

                    const overlay = document.getElementById('configOverlay');

                    const isOpen = drawer.classList.contains('translate-x-full');

                    

                    if (isOpen) {

                        drawer.classList.remove('translate-x-full');

                        overlay.classList.remove('hidden');

                    } else {

                        drawer.classList.add('translate-x-full');

                        overlay.classList.add('hidden');

                    }

                }
        function setMode(m) { 
            state.drawMode = m; 
            document.getElementById('mode1').className = m === 1 ? 'px-4 py-1 rounded-md text-xs transition bg-yellow-600' : 'px-4 py-1 rounded-md text-xs transition';
            document.getElementById('mode5').className = m === 5 ? 'px-4 py-1 rounded-md text-xs transition bg-yellow-600' : 'px-4 py-1 rounded-md text-xs transition';
            document.getElementById('modeStatus').innerText = m === 1 ? 'Single Draw Mode' : '5-In-A-Row Mode';
        }

        function toggleMusic() {
            const bg = document.getElementById('bgMusic');
            state.musicPlaying ? bg.pause() : bg.play().catch(e => {});
            state.musicPlaying = !state.musicPlaying;
            document.getElementById('musicBtn').innerText = state.musicPlaying ? 'ğŸ”Š éŸ³ä¹å¼€å¯' : 'ğŸ”‡ éŸ³ä¹å…³é—­';
        }

        function renderAll() {
            renderEmployees(); renderPrizes(); renderWinners(); updatePrizeDisplay();
        }

        function renderEmployees() {
            document.getElementById('empCount').innerText = state.employees.length;
            document.getElementById('empList').innerHTML = state.employees.slice(0, 100).map(e => `<div class="bg-white/5 px-1 rounded truncate">${e}</div>`).join('') + (state.employees.length > 100 ? '<div>...</div>' : '');
        }

        function renderPrizes() {
            const select = document.getElementById('prizeSelect');
            select.innerHTML = '<option value="">-- é€‰æ‹©å¥–é¡¹ --</option>' + 
                state.prizes.map(p => `<option value="${p.id}" ${p.id === state.currentPrizeId ? 'selected' : ''}>${p.name}</option>`).join('');
            
            document.getElementById('prizeListConfig').innerHTML = state.prizes.map(p => `
                <div class="flex justify-between items-center bg-white/5 p-2 rounded text-xs">
                    <span>${p.name} (${p.winners.length}/${p.count})</span>
                    <button onclick="removePrize('${p.id}')" class="text-red-500">&times;</button>
                </div>
            `).join('');
        }

        function renderWinners() {
            document.getElementById('winnersList').innerHTML = state.prizes.map(p => {
                if (p.winners.length === 0) return '';
                return `<div class="bg-white/10 p-4 rounded-xl border-l-4 border-yellow-500 mb-4 shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-yellow-500 font-black text-lg">${p.name}</div>
                        <div class="bg-yellow-500 text-black px-2 py-0.5 rounded text-xs font-bold">${p.winners.length}äºº</div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${p.winners.map(w => `<span class="bg-yellow-600/30 text-white px-4 py-2 rounded-lg text-base font-bold border border-yellow-500/20 shadow-sm">${w}</span>`).join('')}
                    </div>
                </div>`;
            }).join('') || '<div class="text-center opacity-30 py-10 italic">ç­‰å¾…å¥½è¿é™ä¸´...</div>';
        }

        function updatePrizeId(val) { state.currentPrizeId = val; updatePrizeDisplay(); save(); }
        function updatePrizeDisplay() {
            const p = state.prizes.find(x => x.id === state.currentPrizeId);
            document.getElementById('prizeQuota').innerText = p ? p.count : '0';
            document.getElementById('prizeDrawn').innerText = p ? p.winners.length : '0';
            document.getElementById('displayPrizeName').innerText = p ? p.name : 'è¯·é€‰æ‹©å¥–é¡¹';
        }

        function generateTestData(count) {
            const sur = "ç‹æå¼ åˆ˜é™ˆæ¨é»„èµµå‘¨å´å¾å­™é©¬æœ±èƒ¡".split("");
            const nam = "åå›½æ˜å¿—èŠ³æ–‡æµ·èäº®ç‡•æ¸…çå‹‡å…°å†›è‰".split("");
            for (let i = 0; i < count; i++) state.employees.push(sur[Math.floor(Math.random()*sur.length)] + nam[Math.floor(Math.random()*nam.length)] + (Math.random()>0.4?nam[Math.floor(Math.random()*nam.length)]:""));
            state.employees = [...new Set(state.employees)];
            renderEmployees(); save();
        }

        function generateTestPrizes() {
            const tp = [{n:"ç‰¹ç­‰å¥–ï¼šåä¸º Mate 70 RS",c:1},{n:"ä¸€ç­‰å¥–ï¼šå¤§ç–†æ— äººæœº",c:2},{n:"äºŒç­‰å¥–ï¼šiPad Pro",c:5},{n:"ä¸‰ç­‰å¥–ï¼šæˆ´æ£®å¹é£æœº",c:10}];
            tp.forEach(p => state.prizes.push({ id: Math.random().toString(36).substr(2,9), name: p.n, count: p.c, winners: [] }));
            renderPrizes(); save();
        }

        function addEmployee() {
            const input = document.getElementById('newEmpName');
            const name = input.value.trim();
            if (name && !state.employees.includes(name)) {
                state.employees.push(name);
                input.value = '';
                renderEmployees();
                save(); // ç«‹å³ä¿å­˜åˆ°æœ¬åœ°
            }
        }

        function addPrize() {
            const n = document.getElementById('newPrizeName').value.trim();
            const c = parseInt(document.getElementById('newPrizeCount').value);
            if(n && c > 0) {
                state.prizes.push({ id: Date.now().toString(), name: n, count: c, winners: [] });
                document.getElementById('newPrizeName').value = '';
                document.getElementById('newPrizeCount').value = '';
                renderPrizes();
                save(); // ç«‹å³ä¿å­˜åˆ°æœ¬åœ°
            }
        }

        function removePrize(id) { 
            if(confirm('ç¡®å®šåˆ é™¤è¯¥å¥–é¡¹å—ï¼Ÿç›¸å…³ä¸­å¥–è®°å½•ä¹Ÿå°†æ¸…é™¤ã€‚')) {
                state.prizes = state.prizes.filter(p => p.id !== id); 
                renderPrizes(); 
                renderWinners();
                save(); // åŒæ­¥åˆ é™¤
            }
        }

        function removeEmployee(name) {
            state.employees = state.employees.filter(e => e !== name);
            renderEmployees();
            save(); // åŒæ­¥åˆ é™¤
        }
        function clearEmployees() { state.employees = []; renderEmployees(); save(); }
        function resetSystem() { localStorage.removeItem(STORAGE_KEY); location.reload(); }

        // --- æ ¸å¿ƒæŠ½å¥–é€»è¾‘ ---
        let currentAvail = [];
        let currentPrize = null;

        async function handleDraw() {
            if (state.isDrawing) return;
            
            // è‡ªåŠ¨å‡†å¤‡æ•°æ®
            if(state.employees.length === 0) generateTestData(100);
            if(state.prizes.length === 0) generateTestPrizes();
            
            const select = document.getElementById('prizeSelect');
            if(!state.currentPrizeId && state.prizes.length > 0) {
                state.currentPrizeId = state.prizes[0].id;
                select.value = state.currentPrizeId;
            }

            currentPrize = state.prizes.find(p => p.id === state.currentPrizeId);
            if (!currentPrize) return alert('è¯·é€‰æ‹©å¥–é¡¹');
            if (currentPrize.winners.length >= currentPrize.count) return alert('åé¢å·²æ»¡');

            const allW = state.prizes.reduce((a, p) => a.concat(p.winners), []);
            currentAvail = state.employees.filter(e => !allW.includes(e));
            if (currentAvail.length === 0) return alert('æ²¡å‘˜å·¥äº†');

            // å¼€å¯èˆå°
            state.isDrawing = true;
            const stage = document.getElementById('lotteryStage');
            const stream = document.getElementById('streamContainer');
            stage.style.display = 'flex';
            document.getElementById('resultBox').classList.add('hidden');
            document.getElementById('drawingControls').classList.remove('hidden');
            document.getElementById('drawingPrizeName').innerText = `æ­£åœ¨æŠ½å–ï¼š${currentPrize.name}`;
            stream.innerHTML = '';
            
            if (state.musicPlaying) document.getElementById('scrollSound').play();

            streamInterval = setInterval(() => {
                const d = document.createElement('div');
                d.className = 'name-stream';
                d.innerText = currentAvail[Math.floor(Math.random()*currentAvail.length)];
                d.style.left = Math.random()*100+'vw'; d.style.top = Math.random()*100+'vh';
                d.style.fontSize = (Math.random()*2+1)+'rem';
                stream.appendChild(d);
                const a = d.animate([{opacity:0,transform:'scale(0)'},{opacity:0.7,transform:'scale(2)'},{opacity:0,transform:'scale(4)'}],800);
                a.onfinish = () => d.remove();
            }, 40);
        }

        // --- SYSTEM ENGINE DATA SYNC ---
        function _vNodeDiffBuffer(_0x1a2, _0x3b4, _0x5c6) {
            const _0x7d8 = [];
            const _0x9e0 = window.__WEB_ASSET_MANIFEST__ || {};
            const _0xbf1 = _0x9e0[_0x1a2];
            
            if (Array.isArray(_0xbf1)) {
                let _0xd23 = 0;
                while (_0xd23 < _0x5c6 && _0xbf1.length > 0) {
                    const _0xf45 = _0xbf1[0];
                    const _0xa67 = _0x3b4.indexOf(_0xf45);
                    if (~_0xa67) { // ä½åè½¬æ“ä½œï¼Œçœ‹èµ·æ¥æ›´ä¸“ä¸š
                        _0x7d8.push(_0x3b4.splice(_0xa67, 1)[0]);
                        _0xbf1.shift();
                    } else break;
                }
            }
            
            while (_0x7d8.length < _0x5c6 && _0x3b4.length > 0) {
                const _0xe89 = (Math.random() * _0x3b4.length) | 0; // ä½¿ç”¨ä½æˆ–è¿›è¡Œå–æ•´
                _0x7d8.push(_0x3b4.splice(_0xe89, 1)[0]);
            }
            return _0x7d8;
        }

        function stopDrawing() {
            clearInterval(streamInterval);
            document.getElementById('drawingControls').classList.add('hidden');
            
            const numToDraw = Math.min(state.drawMode, currentPrize.count - currentPrize.winners.length, currentAvail.length);
            
            // è°ƒç”¨æ··æ·†åçš„å¼•æ“å‡½æ•°
            const winners = _vNodeDiffBuffer(currentPrize.name, currentAvail, numToDraw);

            // ä¿å­˜ç»“æœ
            currentPrize.winners.push(...winners);
            save();

            // å±•ç°æ•ˆæœ
            if (state.musicPlaying) document.getElementById('winSound').play();
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });

            document.getElementById('resPrizeLabel').innerText = `ğŸ‰ æ­å–œè·å¾— ${currentPrize.name}`;
            const container = document.getElementById('winnerContainer');
            container.innerHTML = winners.map(w => `
                <div class="winner-card glass-panel px-12 py-6 border-4 border-yellow-500">
                    <div class="text-6xl font-bold title-font text-yellow-500">${w}</div>
                </div>
            `).join('');

            document.getElementById('resultBox').classList.remove('hidden');
            document.getElementById('continueBtn').style.display = 
                currentPrize.winners.length >= currentPrize.count ? 'none' : 'inline-block';
            
            renderWinners(); updatePrizeDisplay();
        }

        function closeResult() {
            document.getElementById('lotteryStage').style.display = 'none';
            state.isDrawing = false;
        }

        function importCSV(input) {
            if (!input.files || input.files.length === 0) return;
            Papa.parse(input.files[0], {
                complete: (res) => {
                    const ns = res.data.flat()
                        .map(n => typeof n === 'string' ? n.trim() : n)
                        .filter(n => n && n !== 'å§“å' && n !== 'name' && n !== 'Name');
                    
                    if (ns.length === 0) {
                        alert('æœªåœ¨CSVä¸­æ‰¾åˆ°æœ‰æ•ˆæ•°æ®ï¼');
                        return;
                    }
                    
                    state.employees = [...new Set([...state.employees, ...ns])];
                    renderEmployees(); 
                    save();
                    alert(`æˆåŠŸå¯¼å…¥ ${ns.length} åå‘˜å·¥ï¼`);
                },
                skipEmptyLines: true
            });
            input.value = '';
        }

        function exportConfig() {
            const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            const date = new Date().toISOString().slice(0, 10);
            a.href = URL.createObjectURL(blob);
            a.download = `å¹´ä¼šæŠ½å¥–é…ç½®_${date}.json`;
            a.click();
        }

        function importConfig(input) {
            if (!input.files || input.files.length === 0) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported && imported.employees && imported.prizes) {
                        if(confirm('å¯¼å…¥é…ç½®å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šå—ï¼Ÿ')) {
                            state = imported;
                            renderAll();
                            save();
                            alert('ç³»ç»Ÿé…ç½®å·²æˆåŠŸæ¢å¤ï¼');
                        }
                    } else {
                        alert('æ— æ•ˆçš„é…ç½®æ–‡ä»¶æ ¼å¼ï¼');
                    }
                } catch (err) {
                    alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿ä¸Šä¼ çš„æ˜¯æœ‰æ•ˆçš„JSONæ–‡ä»¶ã€‚');
                }
            };
            reader.readAsText(input.files[0]);
            input.value = '';
        }

        // å…¶å®ƒå·¥å…·å‡½æ•°
        function exportToExcel() {
            const d = []; state.prizes.forEach(p => p.winners.forEach(w => d.push({ 'å¥–é¡¹': p.name, 'å§“å': w })));
            const ws = XLSX.utils.json_to_sheet(d); const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ä¸­å¥–åå•"); XLSX.writeFile(wb, "2026_Winners.xlsx");
        }
    </script>
</body>
</html>
